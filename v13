import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, deleteDoc, updateDoc } from 'firebase/firestore';

// --- Firebase é…ç½® ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'okayama-2026-v13';

const EXCHANGE_RATE = 0.21;
const JPY_RATE = 4.76;

const DATES = [
  { d: '02-28', w: 'å…­', id: 'day1' }, { d: '03-01', w: 'æ—¥', id: 'day2' },
  { d: '03-02', w: 'ä¸€', id: 'day3' }, { d: '03-03', w: 'äºŒ', id: 'day4' },
  { d: '03-04', w: 'ä¸‰', id: 'day5' }, { d: '03-05', w: 'å››', id: 'day6' },
  { d: '03-06', w: 'äº”', id: 'day7' }, { d: '03-07', w: 'å…­', id: 'day8' },
  { d: '03-08', w: 'æ—¥', id: 'day9' }
];

const HOURS = Array.from({ length: 48 }, (_, i) => {
  const h = Math.floor(i / 2).toString().padStart(2, '0');
  const m = i % 2 === 0 ? '00' : '30';
  return `${h}:${m}`;
});

const PARTNERS = [
  { id: 'salt', name: 'å¡©', emoji: 'ğŸ§‚' },
  { id: 'monkey', name: 'çŒ´', emoji: 'ğŸµ' }
];

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('home');
  const [adminSection, setAdminSection] = useState('itinerary');
  const [selectedDay, setSelectedDay] = useState('day1');
  const [selectedPayer, setSelectedPayer] = useState('salt');
  const [showExpenseModal, setShowExpenseModal] = useState(false);
  
  // æ•¸æ“šç‹€æ…‹
  const [itinerary, setItinerary] = useState({});
  const [expenses, setExpenses] = useState([]);
  const [settings, setSettings] = useState({
    outbound: { airline: 'Tigerair', no: 'IT214', terminal: 'T1', gate: '-', boardingTime: '11:00', duration: '2h 30m', arrivalTime: '15:00', carryOn: '10kg', checkedCount: '1', checkedWeight: '20kg' },
    return: { airline: 'Tigerair', no: 'IT215', terminal: 'T1', gate: '-', boardingTime: '11:00', duration: '2h 30m', arrivalTime: '15:00', carryOn: '10kg', checkedCount: '1', checkedWeight: '20kg' },
    paymentMethods: ['ç¾é‡‘', 'ä¿¡ç”¨å¡', 'Suica', 'Apple Pay'],
    transportMethods: ['JR', 'è·¯é¢é›»è»Š', 'æ¥é§è»Š', 'æ­¥è¡Œ', 'è¨ˆç¨‹è»Š'],
    accommodations: [],
    esim: { salt: { days: '8', data: 'ç„¡é™åˆ¶', note: '', img: '' }, monkey: { days: '8', data: 'ç„¡é™åˆ¶', note: '', img: '' } },
    passes: []
  });

  // --- Firebase åŒæ­¥ ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  useEffect(() => {
    if (!user) return;
    const unsubItn = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'itinerary'), s => {
      const d = {}; s.forEach(doc => d[doc.id] = doc.data()); setItinerary(d);
    }, (err) => console.error(err));

    const unsubExp = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), s => {
      setExpenses(s.docs.map(d => ({ id: d.id, ...d.data() })));
    }, (err) => console.error(err));

    const unsubSet = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), s => {
      if (s.exists()) setSettings(prev => ({ ...prev, ...s.data() }));
    }, (err) => console.error(err));

    return () => { unsubItn(); unsubExp(); unsubSet(); };
  }, [user]);

  const updateSettings = async (path, value) => {
    const newSettings = { ...settings };
    const keys = path.split('.');
    let current = newSettings;
    for (let i = 0; i < keys.length - 1; i++) {
      if (!current[keys[i]]) current[keys[i]] = {};
      current = current[keys[i]];
    }
    current[keys[keys.length - 1]] = value;
    setSettings(newSettings);
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), newSettings, { merge: true });
  };

  const handleImageUpload = (memberId, file) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onloadend = async () => {
      await updateSettings(`esim.${memberId}.img`, reader.result);
    };
    reader.readAsDataURL(file);
  };

  // ç²å–æˆå“¡ç¸½æ”¯å‡º
  const getMemberTotal = (uid) => {
    return expenses
      .filter(e => e.userId === uid)
      .reduce((sum, e) => sum + (e.amount || 0), 0);
  };

  // --- çµ„ä»¶ ---
  const SectionCard = ({ title, icon, children, action }) => (
    <div className="bg-white rounded-[2rem] p-6 md:p-8 border border-slate-200 shadow-sm mb-6 w-full">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <span className="text-2xl">{icon}</span>
          <h2 className="text-xl font-black text-slate-800 tracking-tight">{title}</h2>
        </div>
        {action}
      </div>
      {children}
    </div>
  );

  const FlightCard = ({ title, flight, color }) => (
    <div className={`rounded-3xl p-6 text-white ${color} relative overflow-hidden h-full shadow-lg`}>
      <h3 className="text-[10px] font-black uppercase tracking-widest mb-6 opacity-60">{title} â€¢ {flight?.no}</h3>
      <div className="flex justify-between items-center mb-8">
        <div className="text-center">
          <div className="text-3xl font-black">{title.includes('å»') ? 'TPE' : 'UKB'}</div>
          <div className="text-[9px] font-bold opacity-50 uppercase">{flight?.airline}</div>
        </div>
        <div className="flex-1 px-4 text-center text-2xl">âœˆï¸</div>
        <div className="text-center">
          <div className="text-3xl font-black">{title.includes('å»') ? 'OKJ' : 'TPE'}</div>
          <div className="text-[9px] font-bold opacity-50 uppercase">{title.includes('å»') ? 'Okayama' : 'Taipei'}</div>
        </div>
      </div>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 border-t border-white/10 pt-6">
        <div><div className="text-[8px] opacity-40 font-black uppercase mb-1">èˆªå»ˆ/ç™»æ©Ÿé–€</div><div className="text-sm font-bold">{flight?.terminal} / {flight?.gate}</div></div>
        <div><div className="text-[8px] opacity-40 font-black uppercase mb-1">ç™»æ©Ÿæ™‚é–“</div><div className="text-sm font-bold">{flight?.boardingTime}</div></div>
        <div><div className="text-[8px] opacity-40 font-black uppercase mb-1">æŠµé”æ™‚é–“</div><div className="text-sm font-bold">{flight?.arrivalTime}</div></div>
        <div><div className="text-[8px] opacity-40 font-black uppercase mb-1">è¡Œæé…é¡</div><div className="text-[10px] font-bold">ğŸ§³ {flight?.checkedCount}ä»¶ {flight?.checkedWeight} / ğŸ’ {flight?.carryOn}</div></div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#f8fafc] text-slate-900 pb-20 font-sans">
      <header className="sticky top-0 z-50 p-4">
        <div className="max-w-6xl mx-auto rounded-[2rem] bg-white/80 backdrop-blur-xl border border-white shadow-lg p-2 flex items-center justify-between">
          <div className="flex items-center gap-3 pl-4 cursor-pointer" onClick={() => setActiveTab('home')}>
            <span className="text-xl">ğŸ‘</span>
            <span className="font-black text-sm tracking-tighter uppercase hidden sm:block">Okayama V13</span>
          </div>
          <nav className="flex gap-1 overflow-x-auto no-scrollbar">
            {['home', 'itinerary', 'accounting', 'tickets', 'admin'].map(id => (
              <button key={id} onClick={() => setActiveTab(id)} className={`px-4 py-2 rounded-xl font-bold text-[10px] uppercase tracking-wider transition-all whitespace-nowrap ${activeTab === id ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>
                {id === 'home' && 'ç¸½è¦½'}
                {id === 'itinerary' && 'è¡Œç¨‹'}
                {id === 'accounting' && 'è¨˜å¸³'}
                {id === 'tickets' && 'ç¥¨åˆ¸/ESIM'}
                {id === 'admin' && 'ç®¡ç†'}
              </button>
            ))}
          </nav>
          <div className="flex gap-2 pr-2">
            {PARTNERS.map(p => (
              <button key={p.id} className={`w-8 h-8 rounded-full border-2 transition-all flex items-center justify-center text-sm ${selectedPayer === p.id ? 'border-indigo-500 bg-indigo-50 scale-110' : 'border-transparent opacity-40 grayscale'}`} onClick={() => setSelectedPayer(p.id)}>{p.emoji}</button>
            ))}
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-4 mt-6">
        
        {/* --- ç¸½è¦½ (é¦–é ) --- */}
        {activeTab === 'home' && (
          <div className="space-y-6">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <FlightCard title="å»ç¨‹èˆªç­ (TPE-OKJ)" flight={settings.outbound} color="bg-slate-900" />
              <FlightCard title="å›ç¨‹èˆªç­ (UKB-TPE)" flight={settings.return} color="bg-indigo-900" />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
               <div className="md:col-span-2 bg-white rounded-[2rem] p-8 border border-slate-200">
                  <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">ç›®å‰çš„æˆå“¡ç¸½æ”¯å‡º</h3>
                  <div className="grid grid-cols-2 gap-8">
                    {PARTNERS.map(p => {
                      const jpy = getMemberTotal(p.id);
                      return (
                        <div key={p.id} className="relative p-6 bg-slate-50 rounded-3xl overflow-hidden">
                          <div className="absolute top-4 right-4 text-3xl opacity-20">{p.emoji}</div>
                          <div className="text-[10px] font-black text-slate-400 uppercase mb-1">{p.name} å·²èŠ±è²»</div>
                          <div className="text-2xl font-black text-slate-800">Â¥{Math.round(jpy).toLocaleString()}</div>
                          <div className="text-xs font-bold text-indigo-500 mt-1">â‰ˆ ${Math.round(jpy * EXCHANGE_RATE).toLocaleString()} TWD</div>
                        </div>
                      );
                    })}
                  </div>
               </div>
               <div className="bg-white rounded-[2rem] p-8 border border-slate-200">
                  <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">é¦–é–“ä½å®¿</h3>
                  <div className="text-lg font-black text-slate-800 line-clamp-1">{settings.accommodations?.[0]?.name || "å°šæœªè¨­å®š"}</div>
                  <div className="text-[10px] text-slate-400 mt-2 line-clamp-1">{settings.accommodations?.[0]?.address}</div>
                  <div className="mt-6 pt-6 border-t border-slate-100 flex justify-between items-center">
                     <span className="text-[9px] font-black text-slate-400 uppercase">å…¥ä½æ™‚é–“</span>
                     <span className="text-xs font-bold">{settings.accommodations?.[0]?.checkIn || "--"}</span>
                  </div>
               </div>
            </div>

            {/* è¡Œç¨‹ç¸½è¦½ (Slogan & åœ°å€) */}
            <SectionCard title="9æ—¥è¡Œç¨‹å¿«è¦½" icon="ğŸ—ºï¸">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {DATES.map(d => (
                  <div key={d.id} className="p-5 bg-slate-50 rounded-[1.5rem] border border-slate-100 hover:border-indigo-200 transition-all group">
                    <div className="flex justify-between items-start mb-3">
                      <div className="px-3 py-1 bg-white rounded-lg text-[9px] font-black text-slate-400 shadow-sm">{d.d} ({d.w})</div>
                      <div className="text-[9px] font-black text-indigo-500 uppercase tracking-widest">{itinerary[d.id]?.area || "æœªè¨­å®šåœ°é»"}</div>
                    </div>
                    <div className="text-sm font-black text-slate-700 leading-tight group-hover:text-indigo-600 transition-colors">
                      {itinerary[d.id]?.slogan || "å°šæœªå¡«å¯«ä»Šæ—¥ä¸»é¡Œ..."}
                    </div>
                  </div>
                ))}
              </div>
            </SectionCard>
          </div>
        )}

        {/* --- ç¥¨åˆ¸èˆ‡ eSIM --- */}
        {activeTab === 'tickets' && (
          <div className="space-y-6">
            <SectionCard title="äº¤é€šç¥¨åˆ¸è³‡ç”¢" icon="ğŸ«">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {[...(settings.passes || [])]
                  .sort((a, b) => (b.purchased ? 1 : 0) - (a.purchased ? 1 : 0))
                  .map((pass, i) => (
                  <div key={i} className={`p-6 rounded-[2rem] border relative overflow-hidden transition-all ${pass.purchased ? 'bg-indigo-50 border-indigo-100' : 'bg-slate-50 border-slate-100 opacity-80'}`}>
                    {pass.purchased && <div className="absolute top-3 right-3 bg-indigo-500 text-white text-[8px] font-black px-2 py-0.5 rounded-full uppercase">å·²è³¼è²·</div>}
                    <div className="text-[8px] font-black text-slate-400 uppercase mb-2">{pass.area} â€¢ {pass.days} å¤©</div>
                    <div className="text-lg font-black text-slate-800 mb-1">{pass.name}</div>
                    <div className="text-xl font-black text-slate-900 mb-2">
                      {pass.currency === 'JPY' ? `Â¥${pass.price?.toLocaleString()}` : `$${pass.price?.toLocaleString()}`}
                    </div>
                    {pass.useDateStart && (
                      <div className="text-[9px] font-bold text-indigo-400 bg-white/50 inline-block px-2 py-1 rounded-md mb-3">
                        ğŸ“… {pass.useDateStart} ~ {pass.useDateEnd || 'End'}
                      </div>
                    )}
                    {pass.note && <div className="text-[10px] text-slate-400 mb-3 line-clamp-2">{pass.note}</div>}
                    {pass.link && <a href={pass.link} target="_blank" className="inline-block text-[10px] font-black uppercase text-indigo-600 underline">æŸ¥çœ‹ç¥¨åˆ¸é€£çµ</a>}
                  </div>
                ))}
              </div>
            </SectionCard>

            <SectionCard title="eSIM æ†‘è­‰" icon="ğŸ“¶">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                {PARTNERS.map(p => (
                  <div key={p.id} className="bg-white border border-slate-100 rounded-[2rem] overflow-hidden shadow-sm text-center p-8">
                    <div className="text-4xl mb-4">{p.emoji}</div>
                    <div className="text-xl font-black mb-2">{p.name} çš„ eSIM</div>
                    <div className="text-[10px] font-bold text-slate-400 uppercase mb-6">{settings.esim?.[p.id]?.days} å¤© â€¢ {settings.esim?.[p.id]?.data}</div>
                    {settings.esim?.[p.id]?.img ? (
                      <div className="mx-auto max-w-[200px] border-4 border-slate-50 rounded-2xl overflow-hidden mb-4 shadow-inner">
                         <img src={settings.esim[p.id].img} alt="QR Code" className="w-full" />
                      </div>
                    ) : (
                      <div className="h-40 flex items-center justify-center bg-slate-50 rounded-2xl mb-4 text-slate-300 text-[10px] font-bold uppercase">è«‹è‡³å¾Œå°å°æ‡‰æˆå“¡ä¸Šå‚³åœ–ç‰‡</div>
                    )}
                    <div className="text-xs text-slate-400 italic">{settings.esim?.[p.id]?.note}</div>
                  </div>
                ))}
              </div>
            </SectionCard>
          </div>
        )}

        {/* --- è¡Œç¨‹ --- */}
        {activeTab === 'itinerary' && (
          <div className="space-y-6">
            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
              {DATES.map(d => (
                <button key={d.id} onClick={() => setSelectedDay(d.id)} className={`px-6 py-3 rounded-2xl font-black text-[10px] uppercase transition-all whitespace-nowrap ${selectedDay === d.id ? 'bg-slate-900 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-100'}`}>
                  {d.d} {d.w}
                </button>
              ))}
            </div>
            <SectionCard title={`${selectedDay.toUpperCase()} è¡Œç¨‹ - ${itinerary[selectedDay]?.area || 'åœ°å€'}`} icon="ğŸ“‹">
              <div className="mb-6 p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                <span className="text-[9px] font-black text-indigo-400 uppercase block mb-1">ä»Šæ—¥ä¸»é¡Œ Slogan</span>
                <span className="text-sm font-bold text-slate-700 italic">â€œ {itinerary[selectedDay]?.slogan || "æœªè¨­å®š"} â€</span>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-left min-w-[700px]">
                  <thead>
                    <tr className="border-b border-slate-100 uppercase text-[9px] font-black text-slate-400">
                      <th className="py-4 w-24">æ™‚é–“</th><th className="py-4">è¡Œç¨‹æ´»å‹•</th><th className="py-4 w-28">äº¤é€š</th><th className="py-4">è©³ç´°å‚™è¨»</th><th className="py-4 w-16 text-center">åœ°åœ–</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-50">
                    {(itinerary[selectedDay]?.slots || []).map((slot, i) => (
                      <tr key={i} className="text-sm">
                        <td className="py-5 font-black text-indigo-500">{slot.time}</td>
                        <td className="py-5 font-bold text-slate-700">{slot.activity}</td>
                        <td className="py-5"><span className="px-2 py-1 bg-slate-100 rounded text-[9px] font-black uppercase">{slot.transport}</span></td>
                        <td className="py-5 text-slate-400 text-[11px] leading-relaxed max-w-[200px] truncate">{slot.note}</td>
                        <td className="py-5 text-center">{slot.link && <a href={slot.link} target="_blank" className="grayscale hover:grayscale-0 transition-all">ğŸ“</a>}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </SectionCard>
          </div>
        )}

        {/* --- è¨˜å¸³ --- */}
        {activeTab === 'accounting' && (
           <SectionCard title={`${PARTNERS.find(p=>p.id===selectedPayer)?.name} æ”¯å‡ºæ¸…å–®`} icon="ğŸ’°" action={<button onClick={() => setShowExpenseModal(true)} className="bg-slate-900 text-white px-5 py-2 rounded-xl text-[10px] font-black uppercase">+ æ–°å¢æ”¯å‡º</button>}>
            <div className="overflow-x-auto">
              <table className="w-full text-left">
                <thead className="text-[9px] font-black text-slate-400 uppercase tracking-widest border-b">
                  <tr><th className="py-4">å“é …</th><th className="py-4">æ–¹å¼</th><th className="py-4 text-right">æ—¥å¹£é‡‘é¡</th><th className="py-4 text-right">å°å¹£æ›ç®—</th><th className="py-4 text-right">ç®¡ç†</th></tr>
                </thead>
                <tbody className="divide-y">
                  {expenses.filter(e => e.userId === selectedPayer).map(e => (
                    <tr key={e.id} className="text-sm">
                      <td className="py-4 font-bold">{e.item}</td>
                      <td className="py-4"><span className="px-2 py-1 bg-slate-50 rounded text-[10px] font-black text-slate-400">{e.method}</span></td>
                      <td className="py-4 text-right font-mono font-bold text-slate-600">Â¥{Math.round(e.amount).toLocaleString()}</td>
                      <td className="py-4 text-right font-black text-indigo-500 tracking-tight">${Math.round(e.amount * EXCHANGE_RATE).toLocaleString()}</td>
                      <td className="py-4 text-right"><button onClick={async () => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', e.id))} className="text-[10px] text-red-300 hover:text-red-500 font-bold">ç§»é™¤</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
           </SectionCard>
        )}

        {/* --- ç®¡ç†é é¢ --- */}
        {activeTab === 'admin' && (
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6 pb-20">
            <div className="space-y-2">
              {[
                {id: 'itinerary', name: 'è¡Œç¨‹ç·¨è¼¯'},
                {id: 'stay', name: 'ä½å®¿ç®¡ç†'},
                {id: 'flight', name: 'èˆªç­è¼¸å…¥'},
                {id: 'esim', name: 'eSIM ç®¡ç†'},
                {id: 'pass', name: 'ç¥¨åˆ¸è³‡ç”¢'},
                {id: 'payment', name: 'ç³»çµ±è¨­å®š'}
              ].map(s => (
                <button key={s.id} onClick={() => setAdminSection(s.id)} className={`w-full p-4 rounded-2xl text-left font-black text-[10px] uppercase tracking-wider transition-all ${adminSection === s.id ? 'bg-slate-900 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-100'}`}>
                  {s.name}
                </button>
              ))}
            </div>
            
            <div className="md:col-span-3 space-y-6">
              {/* è¡Œç¨‹ç·¨è¼¯ */}
              {adminSection === 'itinerary' && (
                <SectionCard title="è¡Œç¨‹èˆ‡ä¸»é¡Œç·¨è¼¯" icon="ğŸ–‹ï¸" action={<button onClick={async () => {
                  const currentSlots = itinerary[selectedDay]?.slots || [];
                  const newSlots = [...currentSlots, { time: "09:00", activity: "æ–°è¡Œç¨‹", transport: settings.transportMethods[0], link: "", note: "" }];
                  await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slots: newSlots }, { merge: true });
                }} className="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black">+ æ–°å¢æ™‚æ®µ</button>}>
                   <div className="flex gap-2 overflow-x-auto pb-4 mb-4 border-b border-slate-50">
                      {DATES.map(d => (
                        <button key={d.id} onClick={() => setSelectedDay(d.id)} className={`px-4 py-2 rounded-xl text-[10px] font-black ${selectedDay === d.id ? 'bg-indigo-500 text-white' : 'bg-slate-100 text-slate-400'}`}>{d.id}</button>
                      ))}
                    </div>

                    {/* ä»Šæ—¥ä¸»é¡Œå€å¡Š */}
                    <div className="grid grid-cols-2 gap-4 mb-8 p-6 bg-indigo-50 rounded-3xl">
                       <div>
                          <label className="text-[8px] font-black text-indigo-400 mb-1 block">ä»Šæ—¥éŠç©åœ°å€</label>
                          <input className="w-full p-2 bg-white rounded-lg text-xs font-bold" defaultValue={itinerary[selectedDay]?.area} onBlur={async (e) => await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { area: e.target.value }, { merge: true })} placeholder="ä¾‹å¦‚ï¼šå²¡å±± / å€‰æ•·" />
                       </div>
                       <div>
                          <label className="text-[8px] font-black text-indigo-400 mb-1 block">ä»Šæ—¥ Slogan (ä¸»é¡Œ)</label>
                          <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={itinerary[selectedDay]?.slogan} onBlur={async (e) => await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slogan: e.target.value }, { merge: true })} placeholder="çµ¦ä»Šå¤©ä¸€æ®µå¸¥æ°£çš„æè¿°..." />
                       </div>
                    </div>

                    <div className="space-y-4">
                      {(itinerary[selectedDay]?.slots || []).map((slot, i) => (
                        <div key={i} className="bg-slate-50 p-6 rounded-3xl relative border border-slate-100">
                          <button className="absolute top-4 right-4 text-red-400 text-[10px] font-black" onClick={async () => {
                            const nl = [...itinerary[selectedDay].slots]; nl.splice(i, 1);
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slots: nl }, { merge: true });
                          }}>ç§»é™¤</button>
                          
                          <div className="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                            <div className="md:col-span-2">
                              <label className="text-[8px] font-black text-slate-400 mb-1 block">æ™‚é–“</label>
                              <select className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={slot.time} onChange={e => {
                                const ns = [...itinerary[selectedDay].slots]; ns[i].time = e.target.value;
                                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slots: ns }, { merge: true });
                              }}>
                                {HOURS.map(h => <option key={h} value={h}>{h}</option>)}
                              </select>
                            </div>
                            <div className="md:col-span-6">
                              <label className="text-[8px] font-black text-slate-400 mb-1 block">è¡Œç¨‹å…§å®¹</label>
                              <input className="w-full p-2 bg-white rounded-lg text-xs font-bold" defaultValue={slot.activity} onBlur={e => {
                                const ns = [...itinerary[selectedDay].slots]; ns[i].activity = e.target.value;
                                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slots: ns }, { merge: true });
                              }} />
                            </div>
                            <div className="md:col-span-4">
                              <label className="text-[8px] font-black text-slate-400 mb-1 block">äº¤é€šæ–¹å¼</label>
                              <select className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={slot.transport} onChange={e => {
                                 const ns = [...itinerary[selectedDay].slots]; ns[i].transport = e.target.value;
                                 setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slots: ns }, { merge: true });
                              }}>
                                {settings.transportMethods.map(m => <option key={m} value={m}>{m}</option>)}
                              </select>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label className="text-[8px] font-black text-slate-400 mb-1 block">Google Map é€£çµ</label>
                                <input className="w-full p-2 bg-white rounded-lg text-[10px] font-mono" defaultValue={slot.link} onBlur={e => {
                                   const ns = [...itinerary[selectedDay].slots]; ns[i].link = e.target.value;
                                   setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slots: ns }, { merge: true });
                                }} placeholder="https://..." />
                             </div>
                             <div>
                                <label className="text-[8px] font-black text-slate-400 mb-1 block">è¡Œç¨‹è©³ç´°å‚™è¨»</label>
                                <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={slot.note} onBlur={e => {
                                   const ns = [...itinerary[selectedDay].slots]; ns[i].note = e.target.value;
                                   setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', selectedDay), { slots: ns }, { merge: true });
                                }} placeholder="æ³¨æ„äº‹é …ã€æ¨è–¦é¤é»..." />
                             </div>
                          </div>
                        </div>
                      ))}
                    </div>
                </SectionCard>
              )}

              {/* ä½å®¿ç®¡ç† (å·²ç§»é™¤é›»è©±) */}
              {adminSection === 'stay' && (
                <SectionCard title="ä½å®¿åœ°å€ç®¡ç†" icon="ğŸ¨" action={<button onClick={() => updateSettings('accommodations', [...(settings.accommodations||[]), { name: '', address: '', link: '', checkIn: '' }])} className="text-xs font-black">+ æ–°å¢ä½å®¿</button>}>
                  <div className="space-y-4">
                    {(settings.accommodations || []).map((acc, i) => (
                      <div key={i} className="p-6 bg-slate-50 rounded-3xl border border-slate-100 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div className="col-span-full flex justify-between">
                            <span className="text-[10px] font-black text-indigo-500 uppercase">é£¯åº— #{i+1}</span>
                            <button className="text-red-400 text-[10px] font-bold" onClick={() => { const nl = [...settings.accommodations]; nl.splice(i, 1); updateSettings('accommodations', nl); }}>ç§»é™¤é£¯åº—</button>
                        </div>
                        <input className="w-full p-2 bg-white rounded-lg text-xs font-bold" placeholder="é£¯åº—åç¨±" defaultValue={acc.name} onBlur={e => { const nl = [...settings.accommodations]; nl[i].name = e.target.value; updateSettings('accommodations', nl); }} />
                        <input className="w-full p-2 bg-white rounded-lg text-xs" placeholder="å…¥ä½æ—¥æœŸ/å‚™è¨»" defaultValue={acc.checkIn} onBlur={e => { const nl = [...settings.accommodations]; nl[i].checkIn = e.target.value; updateSettings('accommodations', nl); }} />
                        <input className="w-full p-2 bg-white rounded-lg text-xs col-span-full" placeholder="é£¯åº—åœ°å€" defaultValue={acc.address} onBlur={e => { const nl = [...settings.accommodations]; nl[i].address = e.target.value; updateSettings('accommodations', nl); }} />
                        <input className="w-full p-2 bg-white rounded-lg text-[10px] col-span-full" placeholder="Google Map é€£çµ" defaultValue={acc.link} onBlur={e => { const nl = [...settings.accommodations]; nl[i].link = e.target.value; updateSettings('accommodations', nl); }} />
                      </div>
                    ))}
                  </div>
                </SectionCard>
              )}

              {/* eSIM ç®¡ç† */}
              {adminSection === 'esim' && (
                <SectionCard title="eSIM æ†‘è­‰ç®¡ç†" icon="ğŸ“¶">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {PARTNERS.map(p => (
                      <div key={p.id} className="p-6 bg-slate-50 rounded-3xl space-y-4">
                        <div className="font-black text-sm">{p.emoji} {p.name} è¨­å®š</div>
                        <input type="file" accept="image/*" className="text-[10px] block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:font-black file:bg-indigo-50 file:text-indigo-700" onChange={e => handleImageUpload(p.id, e.target.files[0])} />
                        {settings.esim?.[p.id]?.img && <img src={settings.esim[p.id].img} className="w-20 h-20 rounded border-2 border-white shadow-sm" alt="QR" />}
                        <div className="grid grid-cols-2 gap-2">
                          <input className="w-full p-2 bg-white rounded-lg text-xs" placeholder="å¤©æ•¸" defaultValue={settings.esim?.[p.id]?.days} onBlur={e => updateSettings(`esim.${p.id}.days`, e.target.value)} />
                          <input className="w-full p-2 bg-white rounded-lg text-xs" placeholder="å¯ç”¨é‡" defaultValue={settings.esim?.[p.id]?.data} onBlur={e => updateSettings(`esim.${p.id}.data`, e.target.value)} />
                        </div>
                        <input className="w-full p-2 bg-white rounded-lg text-xs" placeholder="å‚™è¨»" defaultValue={settings.esim?.[p.id]?.note} onBlur={e => updateSettings(`esim.${p.id}.note`, e.target.value)} />
                      </div>
                    ))}
                  </div>
                </SectionCard>
              )}

              {/* äº¤é€šç¥¨åˆ¸ (æ–°å¢å·²è³¼è²·å‹¾é¸èˆ‡æ—¥æœŸå€é–“) */}
              {adminSection === 'pass' && (
                <SectionCard title="ç¥¨åˆ¸è³‡ç”¢ç®¡ç†" icon="ğŸ«" action={<button onClick={() => updateSettings('passes', [...(settings.passes||[]), { name: '', days: '', price: 0, currency: 'JPY', area: '', link: '', note: '', purchased: false, useDateStart: '', useDateEnd: '' }])} className="text-xs font-black">+ æ–°å¢ç¥¨åˆ¸</button>}>
                  <div className="space-y-4">
                    {(settings.passes || []).map((pass, i) => (
                      <div key={i} className={`p-6 rounded-3xl border grid grid-cols-1 md:grid-cols-4 gap-3 relative transition-all ${pass.purchased ? 'bg-indigo-50 border-indigo-200 shadow-inner' : 'bg-slate-50 border-slate-100'}`}>
                        <div className="absolute top-4 right-4 flex items-center gap-4">
                            <label className="flex items-center gap-2 cursor-pointer">
                               <input type="checkbox" checked={pass.purchased || false} onChange={e => { const nl = [...settings.passes]; nl[i].purchased = e.target.checked; updateSettings('passes', nl); }} className="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500" />
                               <span className="text-[10px] font-black text-slate-500 uppercase">å·²è³¼è²·</span>
                            </label>
                            <button className="text-red-400 text-[10px] font-bold" onClick={() => { const nl = [...settings.passes]; nl.splice(i, 1); updateSettings('passes', nl); }}>ç§»é™¤</button>
                        </div>
                        <div className="md:col-span-2">
                            <label className="text-[8px] font-black block mb-1">ç¥¨åˆ¸åç¨±</label>
                            <input className="w-full p-2 bg-white rounded-lg text-xs font-bold" placeholder="åç¨±" defaultValue={pass.name} onBlur={e => { const nl = [...settings.passes]; nl[i].name = e.target.value; updateSettings('passes', nl); }} />
                        </div>
                        <div>
                            <label className="text-[8px] font-black block mb-1">é è¨ˆä½¿ç”¨é–‹å§‹</label>
                            <input type="date" className="w-full p-2 bg-white rounded-lg text-[10px]" defaultValue={pass.useDateStart} onChange={e => { const nl = [...settings.passes]; nl[i].useDateStart = e.target.value; updateSettings('passes', nl); }} />
                        </div>
                        <div>
                            <label className="text-[8px] font-black block mb-1">é è¨ˆä½¿ç”¨çµæŸ</label>
                            <input type="date" className="w-full p-2 bg-white rounded-lg text-[10px]" defaultValue={pass.useDateEnd} onChange={e => { const nl = [...settings.passes]; nl[i].useDateEnd = e.target.value; updateSettings('passes', nl); }} />
                        </div>
                        <div>
                            <label className="text-[8px] font-black block mb-1">é‡‘é¡</label>
                            <input className="w-full p-2 bg-white rounded-lg text-xs" placeholder="é‡‘é¡" defaultValue={pass.price} onBlur={e => { const nl = [...settings.passes]; nl[i].price = parseFloat(e.target.value); updateSettings('passes', nl); }} />
                        </div>
                        <div>
                            <label className="text-[8px] font-black block mb-1">å¹£å€¼</label>
                            <select className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={pass.currency} onChange={e => { const nl = [...settings.passes]; nl[i].currency = e.target.value; updateSettings('passes', nl); }}>
                              <option value="JPY">JPY</option>
                              <option value="TWD">TWD</option>
                           </select>
                        </div>
                        <div className="md:col-span-2">
                            <label className="text-[8px] font-black block mb-1">é€£çµ URL</label>
                            <input className="w-full p-2 bg-white rounded-lg text-[10px]" defaultValue={pass.link} onBlur={e => { const nl = [...settings.passes]; nl[i].link = e.target.value; updateSettings('passes', nl); }} />
                        </div>
                        <div className="md:col-span-4">
                            <label className="text-[8px] font-black block mb-1">å‚™è¨»</label>
                            <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={pass.note} onBlur={e => { const nl = [...settings.passes]; nl[i].note = e.target.value; updateSettings('passes', nl); }} />
                        </div>
                      </div>
                    ))}
                  </div>
                </SectionCard>
              )}

              {/* ç³»çµ±è¨­å®š (è¼¸å…¥ä¿®å¾©ç‰ˆ) */}
              {adminSection === 'payment' && (
                <SectionCard title="ç³»çµ±é¸å–®è¨­å®š" icon="âš™ï¸">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                      <h4 className="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">äº¤é€šå·¥å…·</h4>
                      <div className="space-y-2">
                        {settings.transportMethods.map((m, i) => (
                          <div key={i} className="flex gap-2">
                            <input className="flex-1 p-3 bg-slate-50 rounded-xl text-xs font-bold outline-none" defaultValue={m} onBlur={e => {
                                 const nm = [...settings.transportMethods]; nm[i] = e.target.value; updateSettings('transportMethods', nm);
                            }} />
                            <button className="w-10 h-10 text-slate-300" onClick={() => {
                               const nm = settings.transportMethods.filter((_, idx) => idx !== i); updateSettings('transportMethods', nm);
                            }}>âœ•</button>
                          </div>
                        ))}
                        <button className="w-full py-3 border-2 border-dashed border-slate-100 rounded-xl text-[10px] font-black text-slate-300" onClick={() => updateSettings('transportMethods', [...settings.transportMethods, 'æ–°å·¥å…·'])}>+ æ–°å¢</button>
                      </div>
                    </div>
                    <div>
                      <h4 className="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">æ”¯ä»˜æ–¹å¼</h4>
                      <div className="space-y-2">
                        {settings.paymentMethods.map((m, i) => (
                          <div key={i} className="flex gap-2">
                            <input className="flex-1 p-3 bg-slate-50 rounded-xl text-xs font-bold outline-none" defaultValue={m} onBlur={e => {
                                 const nm = [...settings.paymentMethods]; nm[i] = e.target.value; updateSettings('paymentMethods', nm);
                            }} />
                            <button className="w-10 h-10 text-slate-300" onClick={() => {
                               const nm = settings.paymentMethods.filter((_, idx) => idx !== i); updateSettings('paymentMethods', nm);
                            }}>âœ•</button>
                          </div>
                        ))}
                        <button className="w-full py-3 border-2 border-dashed border-slate-100 rounded-xl text-[10px] font-black text-slate-300" onClick={() => updateSettings('paymentMethods', [...settings.paymentMethods, 'æ–°æ”¯ä»˜'])}>+ æ–°å¢</button>
                      </div>
                    </div>
                  </div>
                </SectionCard>
              )}

              {/* èˆªç­æ‰‹å‹•è¼¸å…¥ */}
              {adminSection === 'flight' && (
                <SectionCard title="èˆªç­è³‡è¨Šç¶­è­·" icon="âœˆï¸">
                  {['outbound', 'return'].map(key => (
                    <div key={key} className="mb-8 last:mb-0 p-8 bg-slate-50 rounded-[2rem] grid grid-cols-2 md:grid-cols-4 gap-4">
                      <h4 className="col-span-full text-[10px] font-black text-indigo-400 uppercase mb-2">{key === 'outbound' ? 'å»ç¨‹ (TPE-OKJ)' : 'å›ç¨‹ (UKB-TPE)'}</h4>
                      <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={settings[key]?.airline} placeholder="èˆªç©º" onBlur={e => updateSettings(`${key}.airline`, e.target.value)} />
                      <input className="w-full p-2 bg-white rounded-lg text-xs font-bold" defaultValue={settings[key]?.no} placeholder="ç­è™Ÿ" onBlur={e => updateSettings(`${key}.no`, e.target.value)} />
                      <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={settings[key]?.boardingTime} placeholder="ç™»æ©Ÿ" onBlur={e => updateSettings(`${key}.boardingTime`, e.target.value)} />
                      <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={settings[key]?.arrivalTime} placeholder="æŠµé”" onBlur={e => updateSettings(`${key}.arrivalTime`, e.target.value)} />
                      <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={settings[key]?.terminal} placeholder="èˆªå»ˆ" onBlur={e => updateSettings(`${key}.terminal`, e.target.value)} />
                      <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={settings[key]?.gate} placeholder="ç™»æ©Ÿé–€" onBlur={e => updateSettings(`${key}.gate`, e.target.value)} />
                      <input className="w-full p-2 bg-white rounded-lg text-xs" defaultValue={settings[key]?.duration} placeholder="æ™‚é•·" onBlur={e => updateSettings(`${key}.duration`, e.target.value)} />
                      <div className="col-span-full grid grid-cols-3 gap-2 border-t pt-4">
                         <input className="w-full p-2 bg-white rounded-lg text-[10px]" defaultValue={settings[key]?.carryOn} placeholder="æ‰‹æ" onBlur={e => updateSettings(`${key}.carryOn`, e.target.value)} />
                         <input className="w-full p-2 bg-white rounded-lg text-[10px]" defaultValue={settings[key]?.checkedCount} placeholder="è¨—é‹ä»¶æ•¸" onBlur={e => updateSettings(`${key}.checkedCount`, e.target.value)} />
                         <input className="w-full p-2 bg-white rounded-lg text-[10px]" defaultValue={settings[key]?.checkedWeight} placeholder="è¨—é‹é‡é‡" onBlur={e => updateSettings(`${key}.checkedWeight`, e.target.value)} />
                      </div>
                    </div>
                  ))}
                </SectionCard>
              )}
            </div>
          </div>
        )}
      </main>

      {/* è¨˜å¸³å½ˆçª— */}
      {showExpenseModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
          <div className="bg-white rounded-[2rem] w-full max-w-sm p-8 shadow-2xl">
            <h3 className="text-xl font-black mb-6">æ–°å¢æ¶ˆè²»æ”¯å‡º</h3>
            <form onSubmit={async (e) => {
              e.preventDefault();
              const fd = new FormData(e.target);
              const amt = parseFloat(fd.get('amount'));
              const finalJpy = fd.get('currency') === 'TWD' ? amt * JPY_RATE : amt;
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
                item: fd.get('item'), amount: finalJpy, method: fd.get('method'), userId: selectedPayer, createdAt: Date.now()
              });
              setShowExpenseModal(false);
            }} className="space-y-4">
              <input name="item" required className="w-full p-4 bg-slate-50 rounded-xl font-bold text-sm" placeholder="æ”¯å‡ºå“é …å…§å®¹" />
              <div className="flex gap-2">
                <input name="amount" type="number" step="0.01" required className="flex-1 p-4 bg-slate-50 rounded-xl font-bold text-sm" placeholder="é‡‘é¡" />
                <select name="currency" className="bg-slate-50 px-4 rounded-xl font-bold text-xs"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
              </div>
              <select name="method" className="w-full p-4 bg-slate-50 rounded-xl font-bold text-sm">
                {settings.paymentMethods?.map(m => <option key={m} value={m}>{m}</option>)}
              </select>
              <button type="submit" className="w-full py-4 bg-slate-900 text-white rounded-xl font-black text-xs uppercase shadow-lg">ç¢ºèªå„²å­˜</button>
              <button type="button" onClick={() => setShowExpenseModal(false)} className="w-full py-2 text-slate-400 text-[10px] font-bold uppercase">å–æ¶ˆé€€å‡º</button>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
